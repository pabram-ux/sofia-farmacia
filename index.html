<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buscador de Medicamentos - Sof√≠a</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            font-family: 'Inter', sans-serif;
            color: #e2e8f0;
        }
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background: radial-gradient(circle at 20% 30%, rgba(59, 130, 246, 0.08) 0%, transparent 50%),
                        radial-gradient(circle at 80% 70%, rgba(59, 130, 246, 0.06) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }
        body::-webkit-scrollbar, html::-webkit-scrollbar { display: none; }
        body, html { -ms-overflow-style: none; scrollbar-width: none; }

        #results-container {
            max-height: 60vh;
            overflow-y: scroll;
            overflow-x: hidden;
            position: relative;
        }
        #results-container::-webkit-scrollbar { width: 8px; display: block; }
        #results-container::-webkit-scrollbar-track { background: rgba(30,41,59,0.5); border-radius: 4px; }
        #results-container::-webkit-scrollbar-thumb { background: #60a5fa; border-radius: 4px; }
        #results-container::-webkit-scrollbar-thumb:hover { background: #3b82f6; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideIn { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        #modal {
            display: none; position: fixed; inset: 0; background: rgba(0, 0, 0, 0.6); z-index: 50;
            animation: fadeIn 0.3s; justify-content: center; align-items: flex-start; padding-top: 5vh;
        }
        .modal-content {
            max-height: 90vh; overflow-y: auto; background: rgba(30, 41, 59, 0.92);
            border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            backdrop-filter: blur(12px); border: 1px solid rgba(59, 130, 246, 0.25);
            animation: slideIn 0.3s; max-width: 90%; width: 520px;
            color: #e2e8f0;
        }

        .loader {
            border: 4px solid #1e293b; border-top: 4px solid #60a5fa; border-radius: 50%;
            width: 40px; height: 40px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #hologramSuggestions {
            position: absolute; background-color: rgba(30,41,59,0.95); border: 1px solid rgba(59,130,246,0.3); border-top: none;
            max-height: 150px; overflow-y: auto; width: 100%;
            left: 0; right: 0; top: 100%; z-index: 20; border-radius: 0 0 8px 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            display: none;
        }
        #hologramSuggestions div {
            padding: 0.75rem 1rem; cursor: pointer; border-bottom: 1px solid rgba(59,130,246,0.15);
            font-size: 0.9rem; color: #cbd5e1;
        }
        #hologramSuggestions div:last-child { border-bottom: none; }
        #hologramSuggestions div:hover { background-color: rgba(59,130,246,0.15); color: #93c5fd; }

        #sofiaInteractionContainer {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            margin-bottom: 20px;
            gap: 20px;
            flex-wrap: wrap;
            min-height: 180px;
        }

        #pharmacistHologram {
            background: linear-gradient(45deg, rgba(59,130,246,0.7), rgba(30,64,175,0.7));
            border-radius: 50%;
            box-shadow: 0 0 20px rgba(96,165,250,0.7), 0 0 40px rgba(59,130,246,0.5);
            width: 150px; height: 150px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: all 0.3s ease-in-out;
            border: 2px solid rgba(147,197,253,0.5);
            animation: pulse 3s infinite alternate, hologram-movement 6s infinite ease-in-out;
            flex-shrink: 0; padding: 5px; overflow: hidden;
        }
        #pharmacistHologram:hover {
            transform: scale(1.05);
            box-shadow: 0 0 30px rgba(96,165,250,1), 0 0 50px rgba(59,130,246,0.8);
        }
        #pharmacistHologram video, #pharmacistHologram img {
            width: 100%; height: 100%; border-radius: 50%; object-fit: cover;
            border: 2px solid rgba(255,255,255,0.6);
        }

        #hologramBubble {
            position: relative; padding: 15px;
            background: linear-gradient(135deg, rgba(30,64,175,0.55), rgba(59,130,246,0.45));
            color: white; border-radius: 12px;
            box-shadow: 0 6px 15px rgba(0,0,0,0.3);
            backdrop-filter: blur(8px); border: 1px solid rgba(147,197,253,0.3);
            font-size: 0.95rem; max-width: 320px; transition: none; z-index: 41;
            display: flex; flex-direction: column; align-items: center; flex-grow: 1;
        }
        #hologramBubble::after {
            content: ''; position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%);
            border-width: 30px; border-style: solid;
            border-color: transparent transparent rgba(30,64,175,0.55) transparent;
        }
        @media (min-width: 641px) {
            #hologramBubble::after {
                bottom: auto; top: 50%; right: 100%; left: auto; transform: translateY(-50%);
                border-color: transparent rgba(30,64,175,0.55) transparent transparent;
            }
        }
        #hologramBubble p { color: white; }
        #hologramBubble input[type="text"] {
            width: 100%; padding: 10px; margin-top: 10px; border: 1px solid rgba(147,197,253,0.4);
            border-radius: 6px; font-size: 1rem; color: #f1f5f9; background: rgba(15,23,42,0.6);
        }
        #hologramBubble button {
            background-color: #3b82f6; color: white; padding: 8px 16px;
            border-radius: 6px; margin-top: 10px; cursor: pointer; transition: all 0.2s;
        }
        #hologramBubble button:hover { background-color: #2563eb; transform: translateY(-1px); }

        .modal-price-reminder {
            background-color: rgba(34,197,94,0.25); color: #bbf7d0;
            padding: 12px 16px; border-radius: 8px; border: 1px solid rgba(34,197,94,0.3);
            margin-bottom: 16px; display: flex; align-items: center; gap: 10px;
            text-align: center; justify-content: center; font-weight: 600;
        }
        .modal-price-reminder img {
            width: 36px; height: 36px; border-radius: 50%; border: 1px solid rgba(255,255,255,0.4);
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 15px rgba(96,165,250,0.6), 0 0 25px rgba(59,130,246,0.4); }
            100% { box-shadow: 0 0 25px rgba(96,165,250,0.9), 0 0 45px rgba(59,130,246,0.7); }
        }
        @keyframes hologram-movement {
            0% { transform: translate(0px, 0px) rotate(0deg); }
            15% { transform: translate(20px, -10px) rotate(5deg); }
            30% { transform: translate(10px, -30px) rotate(10deg); }
            45% { transform: translate(-10px, -20px) rotate(-5deg); }
            60% { transform: translate(-20px, 0px) rotate(-10deg); }
            75% { transform: translate(-10px, 20px) rotate(-5deg); }
            90% { transform: translate(10px, 10px) rotate(5deg); }
            100% { transform: translate(0px, 0px) rotate(0deg); }
        }
        @keyframes searchGlow {
            0% { box-shadow: 0 0 20px rgba(96,165,250,0.8); transform: scale(1); }
            50% { box-shadow: 0 0 40px rgba(59,130,246,1); transform: scale(1.08); }
            100% { box-shadow: 0 0 20px rgba(96,165,250,0.8); transform: scale(1); }
        }
        .search-glow { animation: searchGlow 0.5s ease-out; }

        @media (max-width: 640px) {
            #sofiaInteractionContainer { flex-direction: column; align-items: center; }
            #hologramBubble { margin-top: 20px; margin-left: 0; }
        }
    </style>
</head>
<body class="antialiased flex flex-col">
    <div class="container mx-auto px-4 py-6 relative z-1">
        <div id="sofiaInteractionContainer" class="flex flex-col sm:flex-row items-center justify-center mb-8">
            <div class="relative flex flex-col items-center">
                <div id="sofiaName" class="text-white font-semibold text-xl text-center px-6 py-3 rounded-xl shadow-xl mb-3 cursor-pointer"
                     style="background: linear-gradient(45deg, rgba(59,130,246,0.85), rgba(30,64,175,0.85)); border: 1px solid rgba(147,197,253,0.4); box-shadow: 0 6px 20px rgba(59,130,246,0.3);">
                    Farmac√©utica Virtual Sof√≠a
                </div>
                <div id="pharmacistHologram" class="relative cursor-pointer">
                    <video id="sofiaVideo" src="https://i.imgur.com/V7LA4ev.mp4" autoplay loop muted playsinline class="w-full h-full rounded-full object-cover"></video>
                    <div id="sofiaFallback" class="hidden w-full h-full flex items-center justify-center text-7xl">üíä</div>
                </div>
            </div>

            <div id="hologramBubble" class="relative text-white rounded-xl shadow-xl p-4">
                <p id="hologramMessage" class="text-center font-semibold"></p>
                <div class="relative w-full">
                    <input type="text" id="hologramInput" placeholder="¬øQu√© medicamento buscas?" class="w-full mt-3 p-3 border border-blue-400/40 rounded-lg bg-slate-900/60 text-slate-100 focus:outline-none focus:border-blue-400">
                    <div id="hologramSuggestions" class="hidden"></div>
                </div>
                <button id="hologramClearButton" class="bg-red-600 hover:bg-red-700 text-white px-5 py-2 rounded-lg mt-3 transition">Borrar</button>
            </div>
        </div>

        <div id="loadingIndicator" class="hidden flex flex-col items-center justify-center mt-8 text-blue-400">
            <div class="loader"></div>
            <p class="mt-3 text-lg font-semibold">Cargando base de datos...</p>
        </div>

        <div id="filterLoading" class="hidden flex justify-center items-center mt-6 text-blue-400">
            <div class="loader w-8 h-8"></div>
            <span class="ml-3 text-lg">Buscando medicamentos...</span>
        </div>

        <div id="apiError" class="hidden text-center text-red-400 mt-6 p-5 bg-red-950/40 border border-red-600/50 rounded-xl">
            <i class="fas fa-exclamation-circle mr-2 text-xl"></i> Lo sentimos, hubo un problema al conectar con la base de datos. Intenta m√°s tarde.
        </div>

        <div id="results-container" class="mt-4">
            <div id="results" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
            </div>
            <div id="noResults" class="hidden text-center text-slate-400 mt-8 p-6 bg-slate-800/30 rounded-xl">
                <i class="fas fa-info-circle mr-2"></i> No se encontraron medicamentos. Prueba con otro t√©rmino.
            </div>
        </div>
    </div>

    <div id="modal" class="fixed inset-0 bg-black/60 z-50 flex items-start justify-center" style="padding-top: 5vh;">
        <div class="modal-content p-6">
            <div class="flex justify-between items-center mb-5">
                <h2 id="modalTitle" class="text-2xl font-bold text-blue-300"></h2>
                <span class="close-btn text-3xl cursor-pointer text-slate-400 hover:text-red-400" onclick="closeModal();">
                    <i class="fas fa-times"></i>
                </span>
            </div>
            <div id="modal-details" class="space-y-4 text-slate-200">
            </div>
        </div>
    </div>

    <footer class="bg-slate-900/80 text-slate-300 py-8 mt-auto border-t border-blue-900/30">
        <div class="container mx-auto px-4 text-center">
            <p class="text-xl font-bold mb-3">Farmacia Central</p>
            <p><i class="fas fa-map-marker-alt mr-2"></i>Calle Principal #123, Ciudad Ejemplo</p>
            <p><i class="fas fa-clock mr-2"></i>Horario: Lunes a Viernes 8:00 AM - 8:00 PM</p>
            <p class="mt-5 text-sm">¬© 2025 Buscador de Medicamentos con Sof√≠a. Todos los derechos reservados.</p>
        </div>
    </footer>

    <script>
        // Elementos DOM
        const resultsDiv = document.getElementById('results');
        const noResultsDiv = document.getElementById('noResults');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const filterLoading = document.getElementById('filterLoading');
        const apiErrorDiv = document.getElementById('apiError');
        const modal = document.getElementById('modal');
        const modalDetails = document.getElementById('modal-details');
        const modalTitle = document.getElementById('modalTitle');
        const resultsContainer = document.getElementById('results-container');

        const pharmacistHologram = document.getElementById('pharmacistHologram');
        const sofiaVideo = document.getElementById('sofiaVideo');
        const sofiaFallback = document.getElementById('sofiaFallback');
        const sofiaNameDiv = document.getElementById('sofiaName');
        const hologramBubble = document.getElementById('hologramBubble');
        const hologramMessage = document.getElementById('hologramMessage');
        const hologramInput = document.getElementById('hologramInput');
        const hologramClearButton = document.getElementById('hologramClearButton');
        const hologramSuggestionsDiv = document.getElementById('hologramSuggestions');

        const API_URL = 'https://script.google.com/macros/s/AKfycbwKhFetNgkHtdjQko4hrSYranvwKpgRqfBZeVo5Da4LXFf7Kqiv0HQ74LbrwyeEFNM9/exec';

        let allMedicines = [];
        let currentHeaders = [];
        let currentTipIndex = 0;

        const healthTips = [
            "Hola soy Sof√≠a, ¬°Recuerda mantenerte hidratado! Beber suficiente agua es clave para tu salud.",
            "Hola soy Sof√≠a, Lava tus manos con frecuencia para prevenir resfriados y otras infecciones.",
            "Hola soy Sof√≠a, Una dieta equilibrada y ejercicio regular son fundamentales para tu bienestar.",
            "Hola soy Sof√≠a, Si tienes dudas sobre un medicamento, no dudes en consultar a un profesional de la salud.",
            "Hola soy Sof√≠a, ¬°No te automediques! Consulta siempre a un m√©dico o farmac√©utico antes de tomar un nuevo medicamento."
        ];

        // Debounce helper
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function openModal() {
            modal.style.display = 'flex';
            resultsContainer.classList.add('opacity-60');
        }

        function closeModal() {
            modal.style.display = 'none';
            resultsContainer.classList.remove('opacity-60');
        }

        function toggleHologramBubble(show, message = '', showInputAndButton = true, clearInput = true) {
            hologramMessage.textContent = message;
            if (showInputAndButton) {
                hologramInput.classList.remove('hidden');
                hologramClearButton.classList.remove('hidden');
                if (clearInput) {
                    hologramInput.value = '';
                    hologramSuggestionsDiv.classList.add('hidden');
                }
                hologramInput.focus();
            } else {
                hologramInput.classList.add('hidden');
                hologramClearButton.classList.add('hidden');
                hologramSuggestionsDiv.classList.add('hidden');
            }
        }

        async function fetchAllMedicines() {
            const cached = localStorage.getItem('medicinesCache');
            const cacheTime = localStorage.getItem('medicinesCacheTime');
            if (cached && cacheTime && Date.now() - parseInt(cacheTime) < 3600000) {
                const parsed = JSON.parse(cached);
                allMedicines = parsed.data || [];
                currentHeaders = parsed.headers || [];
                loadingIndicator.classList.add('hidden');
                return;
            }

            loadingIndicator.classList.remove('hidden');
            apiErrorDiv.classList.add('hidden');
            resultsDiv.innerHTML = '';
            noResultsDiv.classList.add('hidden');

            try {
                const response = await fetch(API_URL);
                const data = await response.json();

                if (data.error) {
                    apiErrorDiv.classList.remove('hidden');
                    allMedicines = [];
                    currentHeaders = [];
                } else {
                    allMedicines = data.data || [];
                    currentHeaders = data.headers || [];
                    localStorage.setItem('medicinesCache', JSON.stringify({data: allMedicines, headers: currentHeaders}));
                    localStorage.setItem('medicinesCacheTime', Date.now());
                }
            } catch (error) {
                apiErrorDiv.classList.remove('hidden');
                console.error('Error al obtener los medicamentos:', error);
                allMedicines = [];
                currentHeaders = [];
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        }

        function getColumnIndex(keywords) {
            for (const keyword of keywords) {
                const index = currentHeaders.findIndex(header => header.toLowerCase().includes(keyword));
                if (index !== -1) return index;
            }
            return -1;
        }

        function displayResults(data, headers) {
            resultsDiv.innerHTML = '';
            if (!data || data.length === 0) {
                noResultsDiv.classList.remove('hidden');
                return;
            }
            noResultsDiv.classList.add('hidden');

            const nameIdx   = getColumnIndex(['nombre', 'producto']);
            const priceIdx  = getColumnIndex(['precio', 'costo']);
            const cantIdx   = getColumnIndex(['cantidad']);
            const presIdx   = getColumnIndex(['presentacion']);
            const concIdx   = getColumnIndex(['concentracion']);
            const prinIdx   = getColumnIndex(['principio activo', 'sustancia activa']);
            const labIdx    = getColumnIndex(['laboratorio']);
            const catIdx    = getColumnIndex(['categoria', 'tipo']);
            const codIdx    = getColumnIndex(['codigo']);
            const promIdx   = getColumnIndex(['promocion']);
            const descIdx   = getColumnIndex(['descripcion']);

            // Mapa de categor√≠as ‚Üí √≠conos Font Awesome
            const categoryIcons = {
                'analgesico':       'fas fa-band-aid',
                'antibiotico':      'fas fa-capsules',
                'antiinflamatorio': 'fas fa-thermometer-half',
                'antihistaminico':  'fas fa-allergies',
                'gastrointestinal': 'fas fa-stomach',
                'vitaminas':        'fas fa-apple-alt',
                'suplementos':      'fas fa-vial',
                'prescripcion':     'fas fa-file-prescription',
                'otc':              'fas fa-pills',
                'default':          'fas fa-prescription-bottle-alt'
            };

            data.forEach(item => {
                if (item.mensaje) return;

                const name          = item[headers[nameIdx]] || 'Nombre no disponible';
                const priceRaw      = priceIdx !== -1 && item[headers[priceIdx]] ? item[headers[priceIdx]] : null;
                const price         = priceRaw ? parseFloat(priceRaw).toFixed(2) : 'N/A';
                const cantidad      = cantIdx !== -1 && !isNaN(parseFloat(item[headers[cantIdx]])) ? parseFloat(item[headers[cantIdx]]) : 0;

                let stockColor = cantidad > 0 ? 'text-emerald-400' : 'text-red-400';
                let stockIcon  = cantidad > 0 ? 'fas fa-check-circle' : 'fas fa-times-circle';
                let stockText  = cantidad > 0 ? 'En Stock' : 'Agotado';

                const presentacion  = presIdx !== -1 ? item[headers[presIdx]] : 'N/A';
                const concentracion = concIdx !== -1 ? item[headers[concIdx]] : 'N/A';
                const principioActivo = prinIdx !== -1 ? item[headers[prinIdx]] : 'N/A';
                const laboratorio   = labIdx !== -1 ? item[headers[labIdx]] : 'N/A';
                const categoriaRaw  = catIdx !== -1 ? (item[headers[catIdx]] || '').toLowerCase().trim() : '';
                const promocion     = promIdx !== -1 ? item[headers[promIdx]] : '';
                const descripcion   = descIdx !== -1 ? item[headers[descIdx]] : 'N/A';
                const codigo        = codIdx !== -1 ? item[headers[codIdx]] : 'N/A';

                // Seleccionar √≠cono seg√∫n categor√≠a
                let catIcon = categoryIcons['default'];
                if (categoriaRaw) {
                    for (const key in categoryIcons) {
                        if (categoriaRaw.includes(key)) {
                            catIcon = categoryIcons[key];
                            break;
                        }
                    }
                }

                const row = document.createElement('div');
                row.className = 'bg-slate-800/85 backdrop-blur-md border border-blue-500/20 p-5 rounded-xl shadow-lg hover:shadow-2xl hover:border-blue-400/40 transition-all duration-300 cursor-pointer flex flex-col h-full';

                row.innerHTML = `
                    <div class="flex items-start justify-between mb-3">
                        <!-- Izquierda: √≠cono + nombre -->
                        <div class="flex items-center gap-3 flex-1">
                            <div class="w-10 h-10 rounded-full bg-blue-900/40 flex items-center justify-center text-blue-300 text-xl flex-shrink-0">
                                <i class="${catIcon}"></i>
                            </div>
                            <h3 class="font-bold text-lg text-blue-300 line-clamp-2">${name}</h3>
                        </div>

                        <!-- Derecha: precio resaltado -->
                        <div class="text-right flex-shrink-0 ml-4">
                            ${price !== 'N/A' ? `
                                <div class="text-2xl font-extrabold text-emerald-400 drop-shadow-md">$${price}</div>
                                <div class="text-xs text-slate-400">Precio</div>
                            ` : `
                                <div class="text-xl font-bold text-slate-400">Consultar</div>
                            `}
                        </div>
                    </div>

                    <!-- Contenido inferior -->
                    <div class="flex-1 space-y-2 text-sm text-slate-300">
                        <p>Presentaci√≥n: ${presentacion !== 'N/A' ? presentacion : 'No disponible'}</p>
                        <p>Concentraci√≥n: ${concentracion !== 'N/A' ? concentracion : 'No disponible'}</p>
                        <div class="flex items-center gap-2 ${stockColor} mt-3">
                            <i class="${stockIcon} text-lg"></i>
                            <span class="capitalize font-medium">${stockText}</span>
                        </div>
                        ${promocion ? `
                            <div class="bg-amber-500/20 text-amber-300 text-xs font-semibold px-3 py-1 rounded-full inline-block mt-3 border border-amber-500/30">
                                ¬°Oferta! ${promocion}
                            </div>
                        ` : ''}
                    </div>
                `;

                row.addEventListener('click', () => {
                    modalTitle.textContent = name;

                    modalDetails.innerHTML = `
                        <div class="modal-price-reminder">
                            <img src="https://i.imgur.com/1L0CdPa.png" alt="Sof√≠a">
                            <i class="fas fa-star text-yellow-400"></i>
                            <span>¬°Excelente elecci√≥n! En nuestra farmacia siempre encuentras los mejores precios y variedad.</span>
                        </div>
                        <div class="flex items-center space-x-5 mb-5">
                            <i class="fas fa-pills text-5xl text-blue-400"></i>
                            <div>
                                <p class="text-emerald-400 font-bold text-3xl">${price === 'N/A' ? 'Consultar precio' : `$${price}`}</p>
                                <div class="flex items-center gap-2 ${stockColor} text-lg mt-1">
                                    <i class="${stockIcon}"></i>
                                    <span>${stockText}</span>
                                </div>
                                ${promocion ? `<div class="bg-amber-500/20 text-amber-300 text-xs px-3 py-1 rounded-full mt-2 border border-amber-500/30">¬°Oferta! ${promocion}</div>` : ''}
                            </div>
                        </div>
                        ${descripcion !== 'N/A' ? `<p class="mb-3"><strong>Descripci√≥n:</strong> ${descripcion}</p>` : ''}
                        ${codigo !== 'N/A' ? `<p><strong>C√≥digo:</strong> ${codigo}</p>` : ''}
                        ${presentacion !== 'N/A' ? `<p><strong>Presentaci√≥n:</strong> ${presentacion}</p>` : ''}
                        ${concentracion !== 'N/A' ? `<p><strong>Concentraci√≥n:</strong> ${concentracion}</p>` : ''}
                        ${principioActivo !== 'N/A' ? `<p><strong>Principio Activo:</strong> ${principioActivo}</p>` : ''}
                        ${laboratorio !== 'N/A' ? `<p><strong>Laboratorio:</strong> ${laboratorio}</p>` : ''}
                        ${categoriaRaw ? `<p><strong>Categor√≠a:</strong> ${categoriaRaw.charAt(0).toUpperCase() + categoriaRaw.slice(1)}</p>` : ''}
                    `;
                    openModal();
                });

                resultsDiv.appendChild(row);
            });
        }

        async function handleHologramSearch() {
            const query = hologramInput.value.trim().toLowerCase();
            pharmacistHologram.classList.add('search-glow');
            setTimeout(() => pharmacistHologram.classList.remove('search-glow'), 500);

            if (!query) {
                resultsDiv.innerHTML = '';
                noResultsDiv.classList.add('hidden');
                return;
            }

            const filtered = allMedicines.filter(item =>
                Object.values(item).some(val => val && String(val).toLowerCase().includes(query))
            );
            displayResults(filtered, currentHeaders);
        }

        // Event Listeners
        hologramClearButton.addEventListener('click', () => {
            hologramInput.value = '';
            resultsDiv.innerHTML = '';
            noResultsDiv.classList.add('hidden');
            hologramSuggestionsDiv.classList.add('hidden');
        });

        hologramInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleHologramSearch();
        });

        hologramInput.addEventListener('input', debounce(() => {
            const query = hologramInput.value.trim().toLowerCase();

            if (query.length > 0) {
                filterLoading.classList.remove('hidden');
            } else {
                filterLoading.classList.add('hidden');
                resultsDiv.innerHTML = '';
                noResultsDiv.classList.add('hidden');
                hologramSuggestionsDiv.classList.add('hidden');
                return;
            }

            const nameIdx = getColumnIndex(['nombre', 'producto']);
            const filteredForDisplay = allMedicines.filter(item => {
                const name = item[currentHeaders[nameIdx]];
                return name && name.toLowerCase().includes(query);
            });
            displayResults(filteredForDisplay, currentHeaders);

            if (query.length > 0) {
                const matched = allMedicines.filter(item => {
                    const name = item[currentHeaders[nameIdx]];
                    return name && name.toLowerCase().includes(query);
                }).slice(0, 5);

                hologramSuggestionsDiv.innerHTML = '';
                if (matched.length > 0) {
                    matched.forEach(item => {
                        const name = item[currentHeaders[nameIdx]];
                        const div = document.createElement('div');
                        div.textContent = name;
                        div.addEventListener('click', () => {
                            hologramInput.value = name;
                            handleHologramSearch();
                        });
                        hologramSuggestionsDiv.appendChild(div);
                    });
                    hologramSuggestionsDiv.classList.remove('hidden');
                } else {
                    hologramSuggestionsDiv.classList.add('hidden');
                }
            }

            setTimeout(() => filterLoading.classList.add('hidden'), 400);
        }, 350));

        hologramInput.addEventListener('blur', () => {
            setTimeout(() => hologramSuggestionsDiv.classList.add('hidden'), 150);
        });

        sofiaNameDiv.addEventListener('click', () => {
            currentTipIndex = (currentTipIndex + 1) % healthTips.length;
            toggleHologramBubble(true, healthTips[currentTipIndex], true, false);
        });

        pharmacistHologram.addEventListener('click', () => {
            currentTipIndex = (currentTipIndex + 1) % healthTips.length;
            toggleHologramBubble(true, healthTips[currentTipIndex], true, false);
        });

        modal.addEventListener('click', (e) => {
            if (e.target === modal) closeModal();
        });

        window.onload = async () => {
            await fetchAllMedicines();

            if (sofiaVideo) {
                sofiaVideo.play().catch(() => {
                    sofiaVideo.classList.add('hidden');
                    sofiaFallback.classList.remove('hidden');
                });
            }

            toggleHologramBubble(true, healthTips[currentTipIndex], true, true);
        };
    </script>
</body>

</html>
